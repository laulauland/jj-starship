name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        run: cargo publish --locked
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  homebrew:
    runs-on: ubuntu-latest
    needs: publish
    steps:
      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Get tarball SHA256
        id: sha
        run: |
          sha=$(curl -sL https://github.com/dmmulroy/jj-starship/archive/refs/tags/v${{ steps.version.outputs.version }}.tar.gz | shasum -a 256 | cut -d' ' -f1)
          echo "sha256=$sha" >> $GITHUB_OUTPUT

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: dmmulroy/homebrew-tap
          token: ${{ secrets.TAP_GITHUB_TOKEN }}

      - name: Update formula
        run: |
          sed -i 's|url ".*"|url "https://github.com/dmmulroy/jj-starship/archive/refs/tags/v${{ steps.version.outputs.version }}.tar.gz"|' Formula/jj-starship.rb
          sed -i 's|sha256 ".*"|sha256 "${{ steps.sha.outputs.sha256 }}"|' Formula/jj-starship.rb

      - name: Create PR
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          commit-message: "Update jj-starship to v${{ steps.version.outputs.version }}"
          title: "Update jj-starship to v${{ steps.version.outputs.version }}"
          body: "Automated update from [jj-starship release](https://github.com/dmmulroy/jj-starship/releases/tag/v${{ steps.version.outputs.version }})"
          branch: update-jj-starship-${{ steps.version.outputs.version }}
          base: main
